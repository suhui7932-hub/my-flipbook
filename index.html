<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>교화연구 서재</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Web App Manifest (Inlined via Data URI for single file rule) -->
    <link rel="manifest" href='data:application/json,{"name":"교화연구 서재","short_name":"교화연구","start_url":"./index.html","display":"standalone","background_color":"#020617","theme_color":"#0f172a","icons":[{"src":"https://via.placeholder.com/192x192/fbbf24/020617?text=%EA%B5%90%ED%99%94","sizes":"192x192","type":"image/png"}]}'>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&display=swap');

        :root {
            --midnight-navy: #020617;
            --midnight-gold: #fbbf24;
            --midnight-slate: #1e293b;
        }

        body {
            font-family: 'Noto Serif KR', serif;
            background-color: var(--midnight-navy);
            color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
        }

        .gold-gradient {
            background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .book-card {
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .book-card:active {
            transform: scale(0.95);
        }

        .shelf-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }

        /* 스켈레톤 애니메이션 */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .animate-pulse-custom {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* 스크롤바 숨기기 */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="min-h-screen">

    <!-- Header -->
    <header class="sticky top-0 z-50 bg-slate-950/80 backdrop-blur-md border-b border-slate-800 px-4 py-4">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold gold-gradient tracking-tight">교화연구</h1>
                <p class="text-[10px] text-slate-400 uppercase tracking-[0.2em]">Digital Archive</p>
            </div>
            <button id="installBtn" class="hidden flex items-center gap-2 bg-amber-500/10 border border-amber-500/50 text-amber-500 px-3 py-1.5 rounded-full text-xs font-medium">
                <i data-lucide="download" class="w-3.5 h-3.5"></i>
                앱 설치
            </button>
        </div>
    </header>

    <!-- Quick Jump Navigation -->
    <nav id="yearNav" class="sticky top-[68px] z-40 bg-slate-900 border-b border-slate-800 overflow-x-auto hide-scrollbar">
        <div class="max-w-4xl mx-auto px-4 py-3 flex gap-3 whitespace-nowrap" id="yearButtons">
            <!-- JavaScript가 연도 버튼을 여기에 생성합니다 -->
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto p-4 pb-20">
        <div id="loading" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <!-- Skeleton items -->
            <script>
                for(let i=0; i<6; i++) {
                    document.write(`
                        <div class="space-y-3 animate-pulse-custom">
                            <div class="aspect-[3/4] bg-slate-800 rounded-lg"></div>
                            <div class="h-4 bg-slate-800 rounded w-3/4"></div>
                            <div class="h-3 bg-slate-800 rounded w-1/2"></div>
                        </div>
                    `);
                }
            </script>
        </div>

        <div id="bookContainer" class="space-y-12 hidden">
            <!-- JavaScript가 도서 목록을 여기에 생성합니다 -->
        </div>

        <!-- Error Message -->
        <div id="errorMsg" class="hidden py-20 text-center space-y-4">
            <i data-lucide="alert-circle" class="w-12 h-12 text-slate-600 mx-auto"></i>
            <p class="text-slate-400">데이터를 불러오지 못했습니다.<br><span class="text-xs">CONFIG 설정을 확인해주세요.</span></p>
            <button onclick="window.location.reload()" class="text-amber-500 text-sm underline">다시 시도</button>
        </div>
    </main>

    <!-- Footer Status -->
    <footer class="fixed bottom-0 left-0 right-0 bg-slate-950/90 border-t border-slate-800 py-2 px-4 text-center">
        <p class="text-[10px] text-slate-500">© 2026 Kyohwa Archive Project. Powered by GitHub API.</p>
    </footer>

    <script>
        /**
         * 1. CONFIGURATION (사용자 설정)
         * 본인의 GitHub 계정 정보에 맞게 수정하세요.
         */
        const CONFIG = {
            username: 'suhui7932-hub', // GitHub 사용자명
            repo: 'my-flipbook',     // 저장소 이름
            path: 'books',              // 도서가 저장된 루트 폴더명
            branch: 'main'              // 기본 브랜치
        };

        let deferredPrompt;

        // 초기화
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            fetchLibraryData();
            setupPWA();
        });

        // GitHub API를 통한 데이터 수집
        async function fetchLibraryData() {
            try {
                const yearResponse = await fetch(`https://api.github.com/repos/${CONFIG.username}/${CONFIG.repo}/contents/${CONFIG.path}?ref=${CONFIG.branch}`);
                if (!yearResponse.ok) throw new Error('Repo not found');
                
                const years = await yearResponse.json();
                // 폴더(연도)만 필터링하고 내림차순 정렬
                const yearFolders = years.filter(f => f.type === 'dir').sort((a, b) => b.name.localeCompare(a.name));

                const fullData = [];

                for (const yearFolder of yearFolders) {
                    const bookResponse = await fetch(yearFolder.url);
                    const books = await bookResponse.json();
                    // 폴더(월호)만 필터링하고 내림차순 정렬
                    const bookFolders = books.filter(f => f.type === 'dir').sort((a, b) => b.name.localeCompare(a.name));

                    const bookList = bookFolders.map(book => ({
                        title: book.name,
                        year: yearFolder.name,
                        // 구조 규칙: books/YYYY/MM호/index.html
                        link: `./${CONFIG.path}/${yearFolder.name}/${book.name}/index.html`,
                        // 구조 규칙: books/YYYY/MM호/thumbs/page-001.webp
                        thumb: `./${CONFIG.path}/${yearFolder.name}/${book.name}/thumbs/page-001.webp`
                    }));

                    fullData.push({
                        year: yearFolder.name,
                        books: bookList
                    });
                }

                renderLibrary(fullData);
            } catch (error) {
                console.error('Fetch Error:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('errorMsg').classList.remove('hidden');
            }
        }

        // 화면 렌더링
        function renderLibrary(data) {
            const container = document.getElementById('bookContainer');
            const nav = document.getElementById('yearButtons');
            const loading = document.getElementById('loading');

            loading.classList.add('hidden');
            container.classList.remove('hidden');

            data.forEach((group, index) => {
                // 연도 내비게이션 생성
                const navBtn = document.createElement('button');
                navBtn.className = `px-4 py-1.5 rounded-full text-sm font-medium transition-colors ${index === 0 ? 'bg-amber-500 text-slate-950' : 'bg-slate-800 text-slate-400'}`;
                navBtn.textContent = group.year;
                navBtn.onclick = () => {
                    document.querySelectorAll('#yearButtons button').forEach(b => b.classList.replace('bg-amber-500', 'bg-slate-800'));
                    document.querySelectorAll('#yearButtons button').forEach(b => b.classList.replace('text-slate-950', 'text-slate-400'));
                    navBtn.classList.replace('bg-slate-800', 'bg-amber-500');
                    navBtn.classList.replace('text-slate-400', 'text-slate-950');
                    
                    const target = document.getElementById(`section-${group.year}`);
                    const offset = 120; // Header + Nav height
                    window.scrollTo({ top: target.offsetTop - offset, behavior: 'smooth' });
                };
                nav.appendChild(navBtn);

                // 도서 섹션 생성
                const section = document.createElement('section');
                section.id = `section-${group.year}`;
                section.innerHTML = `
                    <div class="flex items-center gap-4 mb-6">
                        <h2 class="text-2xl font-bold text-amber-500/90">${group.year}</h2>
                        <div class="h-px flex-1 bg-slate-800"></div>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-x-4 gap-y-8">
                        ${group.books.map(book => `
                            <a href="${book.link}" class="book-card group">
                                <div class="relative aspect-[3/4] rounded-lg overflow-hidden shelf-shadow bg-slate-800 border border-slate-700/50">
                                    <img src="${book.thumb}" 
                                         alt="${book.title}" 
                                         class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                                         onerror="this.src='https://via.placeholder.com/300x400/1e293b/64748b?text=No+Cover'">
                                    <div class="absolute inset-0 bg-gradient-to-t from-slate-950/80 via-transparent to-transparent opacity-60"></div>
                                    <div class="absolute bottom-2 right-2">
                                        <div class="bg-amber-500 p-1.5 rounded-full shadow-lg transform translate-y-8 group-hover:translate-y-0 transition-transform">
                                            <i data-lucide="book-open" class="w-3.5 h-3.5 text-slate-950"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <h3 class="text-sm font-medium text-slate-200 line-clamp-1">${book.title}</h3>
                                    <p class="text-[11px] text-slate-500 mt-0.5">${book.year} Archive</p>
                                </div>
                            </a>
                        `).join('')}
                    </div>
                `;
                container.appendChild(section);
            });
            lucide.createIcons();
        }

        // PWA 설정
        function setupPWA() {
            // Service Worker 등록 (Inlined logic)
            if ('serviceWorker' in navigator) {
                const swCode = `
                    const CACHE_NAME = 'kyohwa-archive-v1';
                    self.addEventListener('install', (e) => self.skipWaiting());
                    self.addEventListener('activate', (e) => e.waitUntil(self.clients.claim()));
                    self.addEventListener('fetch', (e) => {});
                `;
                const blob = new Blob([swCode], { type: 'text/javascript' });
                const swUrl = URL.createObjectURL(blob);
                navigator.serviceWorker.register(swUrl).catch(err => console.log('SW failed', err));
            }

            // 설치 버튼 로직
            const installBtn = document.getElementById('installBtn');
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                installBtn.classList.remove('hidden');
            });

            installBtn.addEventListener('click', async () => {
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    installBtn.classList.add('hidden');
                }
                deferredPrompt = null;
            });
        }
    </script>
</body>
</html>